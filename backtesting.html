<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS - Laboratorio de Backtesting & Insights</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --dark-bg: #030712; --card-bg: #111827; --accent-purple: #8b5cf6; --accent-emerald: #10b981; }
        body { background-color: var(--dark-bg); color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; }
        .glass-card { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .metric-card { border-left: 4px solid var(--accent-purple); padding: 1.25rem; border-radius: 1rem; }
        .insight-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; }
        .insight-label { color: #94a3b8; font-weight: 500; }
        .insight-value { font-weight: 800; color: #10b981; }
        th { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; color: #94a3b8; padding: 12px; background: #1f2937; }
        td { padding: 10px; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        select, input { background-color: #1f2937 !important; color: white !important; border: 1px solid #374151 !important; border-radius: 0.5rem; font-size: 12px; padding: 5px 10px; }
        #insights-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: #0f172a; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 20px; border: 1px solid #3b82f6; }
        .engine-header { padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 900; letter-spacing: 1px; }
        .recommendation-box { background: linear-gradient(90deg, #1e1b4b, #312e81); border: 1px solid #4338ca; padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .recommendation-box::after { content: '\f0eb'; font-family: 'Font Awesome 6 Free'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; opacity: 0.1; font-weight: 900; }
        .simulation-border { border-left: 4px solid #f59e0b !important; }
        .valid-badge { background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; border: 1px solid rgba(16, 185, 129, 0.3); }
        /* Mejora Visual para Kelly */
        .kelly-badge { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); padding: 2px 5px; border-radius: 4px; font-weight: 800; }
    </style>
</head>
<body class="min-h-screen">

    <div id="insights-modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h2 class="text-xl font-black italic text-white"><i class="fa-solid fa-chart-line mr-2 text-purple-500"></i>TOP 10 ANALÍTICA PROFUNDA</h2>
                <button onclick="toggleModal()" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div id="ai-recommendation" class="recommendation-box hidden">
                <h3 class="text-xs font-black text-blue-300 uppercase mb-2"><i class="fa-solid fa-robot mr-2"></i>Asistente Estratégico BetAGS</h3>
                <p id="rec-text" class="text-sm font-medium text-white italic">Analizando patrones...</p>
                
                <div id="kelly-management" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                        <p class="text-[10px] text-blue-400 font-black uppercase">Optimización Kelly (Fraccional 0.5)</p>
                        <p id="kelly-advice" class="text-xs text-slate-300 mt-1">Calculando exposición ideal...</p>
                    </div>
                    <div id="gem-alert" class="p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-lg hidden">
                        <p class="text-[10px] text-emerald-400 font-black uppercase">Gema Detectada</p>
                        <p id="gem-text" class="text-xs text-white font-bold tracking-tighter"></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-slate-900/80 p-3 rounded-xl border border-white/10 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Liga Líder</p>
                    <div id="winner-leagues" class="text-xs font-black uppercase tracking-widest text-white italic">-</div>
                </div>
                <div class="bg-slate-900/80 p-3 rounded-xl border border-white/10 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Mercado Top</p>
                    <div id="winner-markets" class="text-xs font-black uppercase tracking-widest text-white italic">-</div>
                </div>
                <div class="bg-slate-900/80 p-3 rounded-xl border border-white/10 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Rango Cuota</p>
                    <div id="winner-odds" class="text-xs font-black uppercase tracking-widest text-white italic">-</div>
                </div>
                <div class="bg-slate-900/80 p-3 rounded-xl border border-white/10 text-center">
                    <p class="text-[9px] text-slate-500 uppercase font-black mb-1">Rango Edge</p>
                    <div id="winner-edge" class="text-xs font-black uppercase tracking-widest text-white italic">-</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="space-y-8">
                    <div class="engine-header bg-purple-600/20 text-purple-400 border border-purple-500/30 uppercase text-sm">Insights Globales</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-[10px] font-black text-blue-400 uppercase mb-2">Top Ligas</h3><div id="v1-top-leagues"></div></div>
                        <div><h3 class="text-[10px] font-black text-emerald-400 uppercase mb-2">Top Mercados</h3><div id="v1-top-markets"></div></div>
                        <div><h3 class="text-[10px] font-black text-orange-400 uppercase mb-2">Top Cuotas</h3><div id="v1-top-odds"></div></div>
                        <div><h3 class="text-[10px] font-black text-pink-400 uppercase mb-2">Top Edge</h3><div id="v1-top-edge"></div></div>
                    </div>
                </div>
                <div class="space-y-8">
                    <div class="engine-header bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 uppercase text-sm">Validación por Equipos (>5 Picks)</div>
                    <div id="validated-teams-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-slate-900 border-b border-purple-500/20 p-4 sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-black italic text-white">BET<span class="text-purple-500">AGS</span> <span class="text-[10px] uppercase tracking-widest text-slate-400 ml-2">Backtesting Lab</span></h1>
            <div class="flex gap-3">
                <button onclick="generateInsights()" class="text-xs bg-purple-600 text-white px-4 py-2 rounded-lg font-black border border-purple-400 hover:bg-purple-500 transition-all shadow-lg shadow-purple-900/40">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>RECOMENDACIÓN ESTRATÉGICA
                </button>
                <a href="index.html" class="text-xs bg-slate-800 text-white px-4 py-2 rounded-lg font-bold border border-slate-700">VOLVER AL MINERO</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-6 space-y-6">
        <div class="glass-card p-4 rounded-2xl border-b-2 border-purple-500">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Mercado</label>
                    <select id="filter-market" class="w-full" onchange="applyFilters()"><option value="all">TODOS</option><option value="GANADOR LOCAL (1)">LOCAL (1)</option><option value="EMPATE (X)">EMPATE (X)</option><option value="GANADOR VISITANTE (2)">VISITANTE (2)</option><option value="OVER 2.5">OVER 2.5</option><option value="UNDER 2.5">UNDER 2.5</option><option value="BTTS SÍ">BTTS SÍ</option><option value="BTTS NO">BTTS NO</option></select>
                </div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Cuota Mín.</label><input type="number" id="filter-min-odd" step="0.1" placeholder="1.0" class="w-full" oninput="applyFilters()"></div>
                <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Cuota Máx.</label><input type="number" id="filter-max-odd" step="0.1" placeholder="10.0" class="w-full" oninput="applyFilters()"></div>
                <div class="bg-orange-500/10 p-2 rounded-lg border border-orange-500/20">
                    <label class="text-[9px] font-black text-orange-400 uppercase block mb-1">Simular Stake Plano</label>
                    <input type="number" id="sim-stake" value="10" step="5" class="w-full !border-orange-500/40" oninput="applyFilters()">
                </div>
                <button onclick="clearBacktest()" class="text-[10px] bg-red-600/20 text-red-400 border border-red-500/30 p-2 rounded uppercase font-black h-[32px]">Borrar Datos</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="glass-card metric-card"><p class="text-[10px] font-black text-slate-500 uppercase">Profit Real</p><h3 id="stat-profit" class="text-2xl font-black text-white">$0.00</h3></div>
            <div class="glass-card metric-card border-emerald-500"><p class="text-[10px] font-black text-slate-500 uppercase">Yield Real</p><h3 id="stat-yield" class="text-2xl font-black text-emerald-400">0%</h3></div>
            <div class="glass-card metric-card simulation-border"><p class="text-[10px] font-black text-orange-500 uppercase">Profit Simulado</p><h3 id="stat-sim-profit" class="text-2xl font-black text-orange-400">$0.00</h3></div>
            <div class="glass-card metric-card simulation-border"><p class="text-[10px] font-black text-orange-500 uppercase">Yield Simulado</p><h3 id="stat-sim-yield" class="text-2xl font-black text-orange-400">0%</h3></div>
            <div class="glass-card metric-card border-blue-500"><p class="text-[10px] font-black text-slate-500 uppercase">Hit Rate</p><h3 id="stat-winrate" class="text-2xl font-black text-blue-400">0%</h3><p id="stat-count" class="text-[10px] text-slate-500 font-bold uppercase">0 PICKS</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 glass-card p-6 rounded-2xl"><canvas id="equityChart" class="h-[350px]"></canvas></div>
            <div class="glass-card p-6 rounded-2xl"><h3 class="font-bold text-slate-300 uppercase text-sm italic mb-4">Rentabilidad Ligas</h3><div id="league-stats" class="space-y-3 overflow-y-auto max-h-[350px]"></div></div>
        </div>

        <div class="glass-card p-6 rounded-2xl border-t-2 border-emerald-500">
            <h3 class="font-black text-white uppercase text-sm italic mb-4 tracking-widest"><i class="fa-solid fa-users-viewfinder mr-2"></i>Insights por Equipo</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Mercado</th>
                            <th class="text-center">Muestra</th>
                            <th class="text-center">W-L</th>
                            <th class="text-right">Profit</th>
                            <th class="text-right">Yield</th>
                            <th class="text-right text-blue-400">Kelly Sug.</th>
                        </tr>
                    </thead>
                    <tbody id="team-insight-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let fullData = JSON.parse(localStorage.getItem('backtesting_data')) || [];
        let filteredData = [];
        let equityChart;
        const MIN_SAMPLE = 5;

        // FUNCIÓN CLAVE: Extrae equipos de "Equipo A - Equipo B" o de campos individuales
        function getTeamNames(pick) {
            let local = pick.local || pick.home || pick.equipo_local || pick.equipoLocal;
            let visitante = pick.visitante || pick.away || pick.equipo_visitante || pick.equipoVisitante;

            if (!local || !visitante) {
                const fullStr = pick.partido || pick.equipo || pick.match || pick.evento || "";
                if (fullStr.includes(" - ")) {
                    const parts = fullStr.split(" - ");
                    local = parts[0]?.trim();
                    visitante = parts[1]?.trim();
                }
            }
            return { local: local || "Desconocido", visitante: visitante || "Desconocido" };
        }

        // MEJORA: Función para calcular el Criterio de Kelly (Fraccional)
        // b = cuota - 1 | p = probabilidad de ganar | q = probabilidad de perder
        // Formula: f = (bp - q) / b
        function calculateKelly(odd, winRate) {
            if (odd <= 1 || winRate === 0) return 0;
            const b = odd - 1;
            const p = winRate / 100;
            const q = 1 - p;
            const f = (b * p - q) / b;
            // Usamos Medio Kelly (f * 0.5) para mayor seguridad y menor volatilidad
            return Math.max(0, f * 0.5); 
        }

        function applyFilters() {
            const market = document.getElementById('filter-market').value;
            const minOdd = parseFloat(document.getElementById('filter-min-odd').value) || 0;
            const maxOdd = parseFloat(document.getElementById('filter-max-odd').value) || 999;
            filteredData = fullData.filter(b => {
                const matchMarket = market === 'all' || b.mercado === market;
                return matchMarket && b.cuota >= minOdd && b.cuota <= maxOdd;
            });
            updateUI();
        }

        function updateUI() {
            renderStats();
            renderEquityChart();
            renderLeagueStats();
            renderTeamTable();
        }

        function renderStats() {
            const simStake = parseFloat(document.getElementById('sim-stake').value) || 0;
            let tProfit = 0, tStaked = 0, tSimP = 0, tSimS = 0, tWins = 0;
            filteredData.forEach(b => {
                tProfit += b.profit; tStaked += b.stake;
                if (b.profit > 0) { tSimP += (b.cuota - 1) * simStake; tSimS += simStake; tWins++; }
                else if (b.profit < 0) { tSimP -= simStake; tSimS += simStake; }
            });
            document.getElementById('stat-profit').innerText = `$${tProfit.toFixed(2)}`;
            document.getElementById('stat-yield').innerText = `${(tStaked > 0 ? (tProfit/tStaked)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-sim-profit').innerText = `$${tSimP.toFixed(2)}`;
            document.getElementById('stat-sim-yield').innerText = `${(tSimS > 0 ? (tSimP/tSimS)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-winrate').innerText = `${(filteredData.length > 0 ? (tWins/filteredData.length)*100 : 0).toFixed(1)}%`;
            document.getElementById('stat-count').innerText = `${filteredData.length} PICKS`;
        }

        function renderEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            const simStake = parseFloat(document.getElementById('sim-stake').value) || 0;
            let cR = 0, cS = 0;
            const rPts = [0], sPts = [0];
            filteredData.forEach(b => { 
                cR += b.profit; rPts.push(cR); 
                if (b.profit > 0) cS += (b.cuota - 1) * simStake; else if (b.profit < 0) cS -= simStake;
                sPts.push(cS);
            });
            if(equityChart) equityChart.destroy();
            equityChart = new Chart(ctx, {
                type: 'line',
                data: { labels: rPts.map((_, i) => i), datasets: [
                    { label: 'Real', data: rPts, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.3 },
                    { label: 'Simulado', data: sPts, borderColor: '#f59e0b', borderDash: [5, 5], tension: 0.3 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8' } } } }
            });
        }

        function renderLeagueStats() {
            const container = document.getElementById('league-stats');
            const stats = {};
            filteredData.forEach(b => { stats[b.liga] = (stats[b.liga] || 0) + b.profit; });
            container.innerHTML = '';
            Object.entries(stats).sort((a,b)=>b[1]-a[1]).forEach(([l, p]) => {
                container.innerHTML += `<div class="insight-row"><span class="insight-label uppercase">${l}</span><span class="${p>=0?'text-emerald-400':'text-red-400'} font-bold">$${p.toFixed(2)}</span></div>`;
            });
        }

        function getTeamData() {
            const teams = {};
            filteredData.forEach(b => {
                const names = getTeamNames(b);
                [names.local, names.visitante].forEach(t => {
                    const key = `${t}_${b.mercado}`;
                    if(!teams[key]) teams[key] = { name: t, market: b.mercado, profit: 0, stake: 0, w: 0, l: 0, count: 0, avgOdd: 0, sumOdd: 0 };
                    teams[key].profit += b.profit; teams[key].stake += b.stake; teams[key].count++;
                    teams[key].sumOdd += b.cuota;
                    if(b.profit > 0) teams[key].w++; else if(b.profit < 0) teams[key].l++;
                    teams[key].avgOdd = teams[key].sumOdd / teams[key].count;
                });
            });
            return teams;
        }

        function renderTeamTable() {
            const tbody = document.getElementById('team-insight-body');
            const data = getTeamData();
            tbody.innerHTML = '';
            Object.values(data).sort((a,b) => b.profit - a.profit).forEach(d => {
                const yieldV = d.stake > 0 ? (d.profit/d.stake)*100 : 0;
                const winRate = (d.w / d.count) * 100;
                
                // MEJORA: Cálculo de Kelly Sugerido por equipo/mercado
                const kellyFrac = calculateKelly(d.avgOdd, winRate);
                const kellyDisplay = kellyFrac > 0 ? (kellyFrac * 100).toFixed(1) + '%' : '0%';

                tbody.innerHTML += `<tr>
                    <td class="font-black text-white uppercase">${d.name}</td>
                    <td class="text-slate-400 font-bold">${d.market}</td>
                    <td class="text-center">${d.count} ${d.count >= MIN_SAMPLE ? '<span class="valid-badge">VALIDADO</span>' : ''}</td>
                    <td class="text-center">${d.w}-${d.l}</td>
                    <td class="text-right font-bold ${d.profit>=0?'text-emerald-400':'text-red-400'}">$${d.profit.toFixed(2)}</td>
                    <td class="text-right">${yieldV.toFixed(1)}%</td>
                    <td class="text-right font-bold text-blue-400">
                        <span class="kelly-badge">${kellyDisplay}</span>
                    </td>
                </tr>`;
            });
        }

        function generateInsights() {
            if(fullData.length === 0) return alert("Sin datos.");
            const analysis = { leagues: {}, markets: {}, odds: {}, edge: {} };
            let globalWins = 0;
            let sumOdds = 0;

            fullData.forEach(b => {
                analysis.leagues[b.liga] = (analysis.leagues[b.liga] || 0) + b.profit;
                analysis.markets[b.mercado] = (analysis.markets[b.mercado] || 0) + b.profit;
                const r = (Math.floor(b.cuota * 2) / 2).toFixed(1);
                analysis.odds[r] = (analysis.odds[r] || 0) + b.profit;
                const e = b.edge ? Math.floor(parseFloat(b.edge) / 5) * 5 + "%" : "0%";
                analysis.edge[e] = (analysis.edge[e] || 0) + b.profit;
                
                if(b.profit > 0) globalWins++;
                sumOdds += b.cuota;
            });

            const fillList = (id, data, prefix = '') => {
                const el = document.getElementById(id); el.innerHTML = '';
                Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0, 10).forEach(([k, v]) => {
                    el.innerHTML += `<div class="insight-row"><span>${prefix} ${k}</span><span class="${v>=0?'text-emerald-400':'text-red-400'} font-black">$${v.toFixed(2)}</span></div>`;
                });
            };

            fillList('v1-top-leagues', analysis.leagues); fillList('v1-top-markets', analysis.markets);
            fillList('v1-top-odds', analysis.odds, 'Cuota'); fillList('v1-top-edge', analysis.edge);

            const getBest = (obj) => Object.entries(obj).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
            document.getElementById('winner-leagues').innerText = getBest(analysis.leagues);
            document.getElementById('winner-markets').innerText = getBest(analysis.markets);
            document.getElementById('winner-odds').innerText = getBest(analysis.odds);
            document.getElementById('winner-edge').innerText = getBest(analysis.edge);

            const teamData = getTeamData();
            const gems = Object.values(teamData).filter(d => d.count >= MIN_SAMPLE && d.profit > 0).sort((a,b) => b.profit - a.profit);
            
            // MEJORA: Lógica AI con Kelly Global
            const globalWinRate = (globalWins / fullData.length) * 100;
            const avgOdd = sumOdds / fullData.length;
            const globalKelly = calculateKelly(avgOdd, globalWinRate);

            document.getElementById('ai-recommendation').classList.remove('hidden');
            document.getElementById('rec-text').innerHTML = `Estrategia: Prioriza <span class="text-yellow-400 font-black">${getBest(analysis.markets)}</span> cuota <span class="text-blue-400 font-black">${getBest(analysis.odds)}</span>.`;
            
            // Actualizar consejo de Kelly
            const kellyAdvice = document.getElementById('kelly-advice');
            if (globalKelly > 0) {
                kellyAdvice.innerHTML = `Según tu WinRate del <span class="text-blue-400 font-bold">${globalWinRate.toFixed(1)}%</span>, Kelly sugiere un stake del <span class="text-blue-400 font-bold">${(globalKelly * 100).toFixed(2)}%</span> de tu banca por operación.`;
            } else {
                kellyAdvice.innerHTML = `Alerta: Tu WinRate actual no justifica un stake positivo. Revisa tu estrategia antes de aumentar el capital.`;
            }

            const gemCont = document.getElementById('gem-alert');
            if(gems.length > 0) {
                gemCont.classList.remove('hidden');
                document.getElementById('gem-text').innerText = `${gems[0].name} (${gems[0].market}) Profit: $${gems[0].profit.toFixed(2)}`;
            }

            const teamList = document.getElementById('validated-teams-list'); teamList.innerHTML = '';
            gems.forEach(g => { teamList.innerHTML += `<div class="p-2 bg-white/5 rounded border border-white/10 flex justify-between items-center text-[11px]"><span>${g.name} [${g.market}]</span><span class="text-emerald-400 font-bold">$${g.profit.toFixed(2)}</span></div>`; });
            toggleModal();
        }

        function toggleModal() { const m = document.getElementById('insights-modal'); m.style.display = (m.style.display === 'flex' ? 'none' : 'flex'); }
        function clearBacktest() { if(confirm('¿Borrar historial?')) { localStorage.removeItem('backtesting_data'); location.reload(); } }
        applyFilters();
    </script>
</body>
</html>
