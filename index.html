<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de P-Value - Análisis de Apuestas</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        textarea { width: 100%; height: 150px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-family: monospace; }
        button { background-color: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #219150; }
        .results { margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { background: #ecf0f1; padding: 15px; border-radius: 6px; text-align: center; border-left: 5px solid #27ae60; }
        .card h3 { margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase; }
        .card p { margin: 10px 0 0; font-size: 22px; font-weight: bold; color: #2c3e50; }
        .interpretation { margin-top: 20px; padding: 15px; border-radius: 6px; line-height: 1.6; }
        .sig-true { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sig-false { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #2c3e50; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>Análisis de P-Value y Rendimiento</h1>
    <p>Pega aquí las filas de tu historial (incluyendo la cabecera o solo los datos):</p>
    <textarea id="csvData" placeholder="Copia y pega desde Excel aquí..."></textarea>
    <button onclick="processData()">Calcular Resultados</button>

    <div id="output" style="display:none;">
        <div class="results">
            <div class="card">
                <h3>Total Apuestas</h3>
                <p id="totalBets">0</p>
            </div>
            <div class="card">
                <h3>Win Rate</h3>
                <p id="winRate">0%</p>
            </div>
            <div class="card">
                <h3>Yield / ROI</h3>
                <p id="yield">0%</p>
            </div>
            <div class="card">
                <h3>P-Value</h3>
                <p id="pValue">0</p>
            </div>
        </div>

        <div id="interpretation" class="interpretation"></div>
        
        <h3>Resumen de Datos Procesados</h3>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
function processData() {
    const rawData = document.getElementById('csvData').value.trim();
    if (!rawData) return;

    const rows = rawData.split('\n');
    let wins = 0;
    let totalBets = 0;
    let totalProfit = 0;
    let totalStaked = 0;
    let sumProbabilities = 0;

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';

    rows.forEach((row, index) => {
        const cols = row.split('\t');
        
        // Ignorar cabecera si existe (buscando si la columna 'Odd' es un número)
        const odd = parseFloat(cols[2]);
        const result = cols[36] ? cols[36].trim().toLowerCase() : "";

        if (!isNaN(odd) && result !== "") {
            totalBets++;
            totalStaked += 1; // Asumimos flat stake de 1 unidad

            // Probabilidad implícita (1/cuota)
            sumProbabilities += (1 / odd);

            if (result === 'winning') {
                wins++;
                totalProfit += (odd - 1);
            } else {
                totalProfit -= 1;
            }

            // Agregar a la tabla visual (primeras 5 columnas para referencia)
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${cols[0]}</td><td>${cols[2]}</td><td>${cols[4]}</td><td>${cols[5]}</td><td>${cols[36]}</td>`;
            tableBody.appendChild(tr);
        }
    });

    if (totalBets === 0) {
        alert("No se detectaron datos válidos. Asegúrate de copiar las columnas correctamente.");
        return;
    }

    // Cálculos Estadísticos
    const winRate = (wins / totalBets) * 100;
    const yieldPercentage = (totalProfit / totalStaked) * 100;
    const expectedWins = sumProbabilities; // Cuántas deberías ganar según las cuotas
    
    // P-Value usando aproximación Normal para la distribución de aciertos
    // Standard Error = sqrt(n * p * q)
    const avgProb = sumProbabilities / totalBets;
    const stdDev = Math.sqrt(totalBets * avgProb * (1 - avgProb));
    const zScore = (wins - expectedWins) / stdDev;
    
    // Función Error para calcular P-value (distribución normal)
    const pValue = 1 - 0.5 * (1 + erf(zScore / Math.sqrt(2)));

    // Mostrar resultados
    document.getElementById('output').style.display = 'block';
    document.getElementById('totalBets').innerText = totalBets;
    document.getElementById('winRate').innerText = winRate.toFixed(2) + '%';
    document.getElementById('yield').innerText = yieldPercentage.toFixed(2) + '%';
    document.getElementById('pValue').innerText = pValue.toFixed(4);

    const interpretation = document.getElementById('interpretation');
    if (pValue < 0.05) {
        interpretation.className = "interpretation sig-true";
        interpretation.innerHTML = `<strong>Resultado Estadísticamente Significativo:</strong> El P-value es menor a 0.05 (${pValue.toFixed(4)}). Esto sugiere que hay menos del 5% de probabilidad de que tus resultados sean por pura suerte. Tu ventaja (edge) parece real.`;
    } else {
        interpretation.className = "interpretation sig-false";
        interpretation.innerHTML = `<strong>Resultado No Significativo:</strong> El P-value es mayor a 0.05 (${pValue.toFixed(4)}). No hay evidencia estadística suficiente para descartar la suerte. Necesitas una muestra más grande o revisar tu modelo.`;
    }
}

// Función matemática Error (ERF) para aproximación de P-Value
function erf(x) {
    const a1 =  0.254829592; const a2 = -0.284496736; const a3 =  1.421413741;
    const a4 = -1.453152027; const a5 =  1.061405429; const p  =  0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return sign * y;
}
</script>

</body>
</html>
