<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Intelligence - Backtesting Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0f1e; --panel: #161c2d; --accent: #00f2ff; --win: #00ff88; --loss: #ff0055; --text: #e2e8f0; --gold: #ffd700; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: auto; }
        
        .glass { background: var(--panel); border: 1px solid #2d3748; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; }
        textarea { width: 100%; height: 60px; background: #050811; border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); padding: 10px; font-family: monospace; font-size: 11px; }
        .btn { background: linear-gradient(90deg, #00c6ff, #0072ff); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 800; width: 100%; cursor: pointer; margin-top: 10px; text-transform: uppercase; }

        .backtest-header { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .backtest-card { padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #334155; }
        .flat { border-top: 4px solid var(--accent); }
        .dynamic { border-top: 4px solid var(--gold); background: rgba(255, 215, 0, 0.05); }

        .val { font-size: 1.8rem; font-weight: 900; display: block; margin: 5px 0; }
        .chart-box { background: var(--panel); padding: 15px; border-radius: 12px; height: 400px; border: 1px solid #2d3748; }
        
        .comparison-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; }
        .trend-up { color: var(--win); }
        .trend-down { color: var(--loss); }
    </style>
</head>
<body>

<div class="container">
    <div class="glass" style="text-align: center;">
        <h1 style="margin:0; color:var(--accent);">SIMULADOR DE <span style="color:#fff">BACKTESTING</span></h1>
        <small>Comparativa: Stake Plano vs. Algoritmo Dinámico</small>
    </div>

    <div class="glass">
        <textarea id="rawInput" placeholder="Pega tu historial aquí..."></textarea>
        <button class="btn" onclick="runBacktest()">EJECUTAR SIMULACIÓN COMPARATIVA</button>
    </div>

    <div id="resultsUI" style="display:none;">
        <div class="backtest-header">
            <div class="backtest-card flat">
                <div class="comparison-label">Profit (Stake Plano)</div>
                <span class="val" id="flat-profit">0.00u</span>
                <small id="flat-yield">0% Yield</small>
            </div>
            <div class="backtest-card dynamic">
                <div class="comparison-label">Profit (Stake Dinámico)</div>
                <span class="val" id="dyn-profit" style="color: var(--gold);">0.00u</span>
                <small id="dyn-yield">0% Yield</small>
            </div>
        </div>

        <div class="glass" id="verdict-box" style="text-align: center; font-weight: bold; font-size: 1.1rem;"></div>

        <div class="chart-box">
            <canvas id="compChart"></canvas>
        </div>
    </div>
</div>

<script>
let compChart = null;

function runBacktest() {
    const input = document.getElementById('rawInput').value.trim();
    if(!input) return;

    const rows = input.split('\n');
    let picks = [];
    rows.forEach(r => {
        const c = r.split('\t').map(s => s.trim());
        let odd, res;
        if (c[36] && (c[36].toLowerCase().includes('win') || c[36].toLowerCase().includes('los'))) {
            odd = parseFloat(c[2]); res = c[36].toLowerCase();
        } else if (c[29] && (c[29].toLowerCase().includes('win') || c[29].toLowerCase().includes('los'))) {
            odd = parseFloat(c[2]); res = c[29].toLowerCase();
        }
        if(!isNaN(odd) && res) picks.push({ odd, res });
    });

    if(picks.length < 15) return alert("Necesitas al menos 15 picks para un backtest fiable.");

    simulate(picks);
}

function simulate(picks) {
    document.getElementById('resultsUI').style.display = 'block';

    let flatHistory = [0];
    let dynHistory = [0];
    let flatProfit = 0;
    let dynProfit = 0;
    let totalStakedDyn = 0;

    for(let i = 0; i < picks.length; i++) {
        const p = picks[i];
        const isWin = p.res === 'winning';
        
        // 1. Lógica Stake Plano
        const flatGain = isWin ? (p.odd - 1) : -1;
        flatProfit += flatGain;
        flatHistory.push(Number(flatProfit.toFixed(2)));

        // 2. Lógica Stake Dinámico (Mira los 10 anteriores)
        let currentStake = 1.0;
        if(i >= 10) {
            const window = picks.slice(i-10, i);
            const windowProfit = window.reduce((a, b) => a + (b.res === 'winning' ? (b.odd-1) : -1), 0);
            // Algoritmo: Stake = 1 + (ProfitL10 / 10). Min 0.5, Max 2.5
            currentStake = Math.max(0.5, Math.min(2.5, 1 + (windowProfit / 10)));
        }

        const dynGain = isWin ? (currentStake * (p.odd - 1)) : -currentStake;
        dynProfit += dynGain;
        totalStakedDyn += currentStake;
        dynHistory.push(Number(dynProfit.toFixed(2)));
    }

    // Actualizar UI
    document.getElementById('flat-profit').innerText = flatProfit.toFixed(2) + "u";
    document.getElementById('dyn-profit').innerText = dynProfit.toFixed(2) + "u";
    
    const flatY = (flatProfit / picks.length) * 100;
    const dynY = (dynProfit / totalStakedDyn) * 100;
    
    document.getElementById('flat-yield').innerText = flatY.toFixed(2) + "% Yield";
    document.getElementById('dyn-yield').innerText = dynY.toFixed(2) + "% Yield";

    const verdict = document.getElementById('verdict-box');
    if(dynProfit > flatProfit) {
        verdict.innerHTML = `<span class="trend-up">¡EL ALGORITMO GANA!</span> Habrías ganado ${(dynProfit - flatProfit).toFixed(2)}u más con Stake Dinámico.`;
        verdict.style.borderColor = "var(--win)";
    } else {
        verdict.innerHTML = `<span class="trend-down">STAKE PLANO ES MEJOR.</span> En este historial, la varianza no justificó el cambio de stake.`;
        verdict.style.borderColor = "var(--loss)";
    }

    renderChart(flatHistory, dynHistory);
}

function renderChart(flat, dyn) {
    const ctx = document.getElementById('compChart').getContext('2d');
    if(compChart) compChart.destroy();
    
    compChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: flat.map((_, i) => i),
            datasets: [
                {
                    label: 'Stake Plano (1u)',
                    data: flat,
                    borderColor: '#00f2ff',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.2
                },
                {
                    label: 'Algoritmo Dinámico',
                    data: dyn,
                    borderColor: '#ffd700',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#fff', font: { size: 12 } } }
            },
            scales: {
                y: { grid: { color: '#2d3748' }, ticks: { color: '#94a3b8' } },
                x: { display: false }
            }
        }
    });
}
</script>
</body>
</html>
