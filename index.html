<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Intelligence - Strategy Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --win: #10b981; --loss: #ef4444; --text: #f1f5f9; --gold: #fbbf24; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1200px; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding: 15px 0; }
        .input-area { background: var(--panel); padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid #334155; }
        textarea { width: 100%; height: 70px; background: #0a0f1e; border: 1px solid #475569; border-radius: 8px; color: var(--accent); padding: 10px; font-size: 11px; }
        
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; text-transform: uppercase; }

        /* Reporte de Mejora */
        .advisor-box { background: linear-gradient(145deg, #1e293b, #111827); border: 1px solid var(--gold); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .advisor-box h2 { color: var(--gold); margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .advice-item { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); font-size: 0.9rem; }
        .advice-item b { color: var(--accent); }

        /* KPIs */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: var(--panel); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        .kpi-card small { color: #94a3b8; font-size: 0.7rem; display: block; margin-bottom: 5px; }
        .kpi-card span { font-size: 1.2rem; font-weight: bold; }

        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        @media (min-width: 768px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
        .chart-box { background: var(--panel); padding: 15px; border-radius: 12px; height: 300px; border: 1px solid #334155; }

        .scroll-table { overflow-x: auto; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; background: var(--panel); font-size: 0.8rem; }
        th { background: #334155; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #334155; }
        .win { color: var(--win); font-weight: bold; }
        .loss { color: var(--loss); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>POISSON <span style="color:var(--accent)">ADVISOR</span></h1>
        <small>Smart Optimization Engine</small>
    </div>

    <div class="input-area">
        <textarea id="rawInput" placeholder="Pega tu historial aquí..."></textarea>
        <button class="btn" onclick="startAnalysis()">Analizar y Sugerir Mejoras</button>
    </div>

    <div id="results" style="display:none;">
        <div class="advisor-box">
            <h2>&#128161; Sugerencias de Mejora Estratégica</h2>
            <div id="adviceList"></div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><small>YIELD</small><span id="k-yield">0%</span></div>
            <div class="kpi-card"><small>P-VALUE</small><span id="k-p">0.00</span></div>
            <div class="kpi-card"><small>DRAWDOWN</small><span id="k-dd" style="color:var(--loss)">0u</span></div>
            <div class="kpi-card"><small>EFFICIENCY</small><span id="k-eff">0%</span></div>
        </div>

        <div class="charts-grid">
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
            <div class="chart-box"><canvas id="leagueChart"></canvas></div>
        </div>
    </div>
</div>

<script>
let charts = {};

function startAnalysis() {
    const raw = document.getElementById('rawInput').value.trim();
    if(!raw) return;

    const rows = raw.split('\n');
    let db = [];
    rows.forEach(r => {
        const c = r.split('\t').map(s => s.trim());
        let odd, res, league, match;
        
        // Detección multi-formato
        if (c[36] && (c[36].toLowerCase().includes('win') || c[36].toLowerCase().includes('los'))) {
            odd = parseFloat(c[2]); res = c[36].toLowerCase(); league = c[4]; match = c[5];
        } else if (c[29] && (c[29].toLowerCase().includes('win') || c[29].toLowerCase().includes('los'))) {
            odd = parseFloat(c[2]); res = c[29].toLowerCase(); league = c[4]; match = c[5];
        }

        if(!isNaN(odd) && res) {
            db.push({ match, league, odd, res, profit: res === 'winning' ? (odd-1) : -1, prob: 1/odd });
        }
    });

    if(db.length === 0) return alert("No se detectaron datos válidos.");
    
    document.getElementById('results').style.display = 'block';
    renderAdvisor(db);
}

function renderAdvisor(db) {
    const n = db.length;
    const wins = db.filter(x => x.res === 'winning').length;
    const totalProfit = db.reduce((a, b) => a + b.profit, 0);
    const yieldPct = (totalProfit / n) * 100;
    
    // P-Value
    const expWins = db.reduce((a, b) => a + b.prob, 0);
    const variance = db.reduce((a, b) => a + (b.prob * (1 - b.prob)), 0);
    const z = (wins - expWins) / Math.sqrt(variance);
    const pValue = 1 - (0.5 * (1 + erf(z / Math.sqrt(2))));

    // Lógicas de Sugerencia
    const adviceList = document.getElementById('adviceList');
    let adviceHtml = "";

    // 1. Sugerencia de Ligas
    const lMap = {};
    db.forEach(x => { lMap[x.league] = (lMap[x.league] || 0) + x.profit; });
    const sortedLigas = Object.entries(lMap).sort((a,b) => a[1] - b[1]);
    const toxicLeague = sortedLigas[0];
    
    if(toxicLeague[1] < 0) {
        adviceHtml += `<div class="advice-item"><b>Elimina Ligas Tóxicas:</b> Tu rendimiento en <u>${toxicLeague[0]}</u> es negativo (${toxicLeague[1].toFixed(2)}u). Dejar de apostar aquí aumentaría tu Yield inmediatamente.</div>`;
    }

    // 2. Sugerencia de Cuotas (Rango de Oro)
    const ranges = { low: [], mid: [], high: [] };
    db.forEach(x => {
        if(x.odd < 1.7) ranges.low.push(x.profit);
        else if(x.odd < 2.2) ranges.mid.push(x.profit);
        else ranges.high.push(x.profit);
    });
    
    const profits = { 
        "Cuotas Bajas (<1.70)": ranges.low.reduce((a,b)=>a+b,0),
        "Cuotas Medias (1.70-2.20)": ranges.mid.reduce((a,b)=>a+b,0),
        "Cuotas Altas (>2.20)": ranges.high.reduce((a,b)=>a+b,0)
    };
    const bestRange = Object.entries(profits).sort((a,b) => b[1] - a[1])[0];
    adviceHtml += `<div class="advice-item"><b>Focaliza tu Stake:</b> Tu mayor beneficio proviene de <b>${bestRange[0]}</b>. Considera especializarte en este rango de cuotas.</div>`;

    // 3. Sugerencia de Varianza
    if(pValue > 0.1) {
        adviceHtml += `<div class="advice-item"><b>Control de Riesgo:</b> Tu P-Value es alto. No subas el stake todavía; los datos sugieren que podrías estar en una racha de suerte.</div>`;
    } else {
        adviceHtml += `<div class="advice-item"><b>Escalabilidad:</b> Sistema sólido. Podrías aplicar un Interés Compuesto moderado (incremento de stake del 5% cada 20 unidades de beneficio).</div>`;
    }

    adviceList.innerHTML = adviceHtml;

    // Actualizar KPIs
    document.getElementById('k-yield').innerText = yieldPct.toFixed(2) + '%';
    document.getElementById('k-p').innerText = pValue.toFixed(4);
    document.getElementById('k-eff').innerText = ((wins/expWins)*100).toFixed(1) + '%';
    
    updateVisuals(db);
}

function updateVisuals(db) {
    if(charts.e) charts.e.destroy();
    if(charts.l) charts.l.destroy();

    const ctxE = document.getElementById('mainChart').getContext('2d');
    let cur = 0;
    charts.e = new Chart(ctxE, {
        type: 'line',
        data: {
            labels: db.map((_,i)=>i),
            datasets: [{ label: 'Equity', data: db.map(x => cur += x.profit), borderColor: '#38bdf8', fill: true, backgroundColor: 'rgba(56,189,248,0.1)', pointRadius: 0 }]
        },
        options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evolución de Unidades', color: '#fff' } } }
    });

    const ctxL = document.getElementById('leagueChart').getContext('2d');
    const lNames = [...new Set(db.map(x => x.league))].slice(0,6);
    const lProfits = lNames.map(name => db.filter(x => x.league === name).reduce((a,b)=>a+b.profit,0));
    
    charts.l = new Chart(ctxL, {
        type: 'bar',
        data: {
            labels: lNames,
            datasets: [{ label: 'Profit por Liga', data: lProfits, backgroundColor: lProfits.map(v => v>0?'#10b981':'#ef4444') }]
        },
        options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Rentabilidad por Liga (Top 6)', color: '#fff' } } }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>
</body>
</html>
