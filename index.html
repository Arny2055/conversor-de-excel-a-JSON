<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Premium de Apuestas - P-Value & Drawdown</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #1a1a1a; margin: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #1e3a8a; text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 25px; }
        textarea { width: 100%; height: 120px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; }
        button { background-color: #2563eb; color: white; border: none; padding: 14px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; transition: 0.3s; }
        button:hover { background-color: #1d4ed8; }
        
        .results { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 25px; }
        .card { background: #ffffff; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; }
        .card h3 { margin: 0; font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .card p { margin: 10px 0 0; font-size: 24px; font-weight: 800; color: #1e293b; }
        
        .chart-container { margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; height: 400px; }
        
        .interpretation { margin-top: 20px; padding: 20px; border-radius: 8px; font-size: 15px; line-height: 1.6; }
        .sig-true { background-color: #dcfce7; color: #166534; border-left: 6px solid #22c55e; }
        .sig-false { background-color: #fee2e2; color: #991b1b; border-left: 6px solid #ef4444; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        th { background-color: #f8fafc; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <h1>Analizador de Estrategia Poisson</h1>
    <p class="subtitle">Calcula la ventaja estadística y visualiza el riesgo de tu historial</p>
    
    <textarea id="csvData" placeholder="Pega aquí tus datos desde Excel (incluyendo cabecera)..."></textarea>
    <button onclick="processData()">Analizar Historial</button>

    <div id="output" style="display:none;">
        <div class="results">
            <div class="card"><h3>Total Picks</h3><p id="totalBets">0</p></div>
            <div class="card"><h3>Yield %</h3><p id="yield">0%</p></div>
            <div class="card"><h3>P-Value</h3><p id="pValue">0</p></div>
            <div class="card"><h3>Max Drawdown</h3><p id="drawdown" style="color: #dc2626;">0u</p></div>
            <div class="card"><h3>Profit Total</h3><p id="totalProfit">0u</p></div>
        </div>

        <div id="interpretation" class="interpretation"></div>
        
        <div class="chart-container">
            <canvas id="profitChart"></canvas>
        </div>

        <h3>Detalle de Sesión</h3>
        <div style="overflow-x:auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Nombre</th><th>Cuota</th><th>Liga</th><th>Partido</th><th>Resultado</th><th>Profit Acum.</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let myChart = null;

function processData() {
    const rawData = document.getElementById('csvData').value.trim();
    if (!rawData) return;

    const rows = rawData.split('\n');
    let wins = 0, totalBets = 0, totalProfit = 0, totalStaked = 0, sumProbabilities = 0;
    let profitHistory = [0];
    let maxProfitSoFar = 0;
    let maxDrawdown = 0;

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';

    rows.forEach((row) => {
        const cols = row.split('\t');
        const odd = parseFloat(cols[2]);
        const result = cols[36] ? cols[36].trim().toLowerCase() : "";

        if (!isNaN(odd) && result !== "") {
            totalBets++;
            totalStaked += 1; // Flat Stake de 1 unidad
            sumProbabilities += (1 / odd);

            let currentWin = 0;
            if (result === 'winning') {
                wins++;
                currentWin = (odd - 1);
            } else if (result === 'losing') {
                currentWin = -1;
            }
            
            totalProfit += currentWin;
            profitHistory.push(Number(totalProfit.toFixed(2)));

            // Calcular Max Drawdown
            if (totalProfit > maxProfitSoFar) maxProfitSoFar = totalProfit;
            let currentDrawdown = maxProfitSoFar - totalProfit;
            if (currentDrawdown > maxDrawdown) maxDrawdown = currentDrawdown;

            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${cols[0]}</td><td>${cols[2]}</td><td>${cols[4]}</td><td>${cols[5]}</td>
                            <td style="color:${result === 'winning' ? 'green' : 'red'}">${cols[36]}</td>
                            <td>${totalProfit.toFixed(2)}u</td>`;
            tableBody.appendChild(tr);
        }
    });

    if (totalBets === 0) {
        alert("No se encontraron datos válidos. Revisa el formato.");
        return;
    }

    // Estadísticas
    const yieldPct = (totalProfit / totalStaked) * 100;
    const avgProb = sumProbabilities / totalBets;
    const expectedWins = sumProbabilities;
    const stdDev = Math.sqrt(totalBets * avgProb * (1 - avgProb));
    const zScore = (wins - expectedWins) / stdDev;
    const pValue = 1 - 0.5 * (1 + erf(zScore / Math.sqrt(2)));

    // Mostrar UI
    document.getElementById('output').style.display = 'block';
    document.getElementById('totalBets').innerText = totalBets;
    document.getElementById('yield').innerText = yieldPct.toFixed(2) + '%';
    document.getElementById('pValue').innerText = pValue.toFixed(4);
    document.getElementById('drawdown').innerText = '-' + maxDrawdown.toFixed(2) + 'u';
    document.getElementById('totalProfit').innerText = totalProfit.toFixed(2) + 'u';

    // Interpretación
    const interDiv = document.getElementById('interpretation');
    if (pValue < 0.05) {
        interDiv.className = "interpretation sig-true";
        interDiv.innerHTML = `<strong>¡Ventaja confirmada!</strong> El P-value (${pValue.toFixed(4)}) indica que tus resultados son sólidos. Solo hay un ${(pValue*100).toFixed(2)}% de probabilidad de que esto sea suerte.`;
    } else {
        interDiv.className = "interpretation sig-false";
        interDiv.innerHTML = `<strong>Varianza detectada:</strong> El P-value (${pValue.toFixed(4)}) es alto. Es posible que los resultados positivos actuales sean temporales o necesites una muestra mayor para confirmar tu edge.`;
    }

    // Gráfica
    renderChart(profitHistory);
}

function renderChart(dataPoints) {
    const ctx = document.getElementById('profitChart').getContext('2d');
    if (myChart) myChart.destroy();
    
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dataPoints.map((_, i) => i),
            datasets: [{
                label: 'Beneficio Acumulado (Unidades)',
                data: dataPoints,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.3,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: '#e2e8f0' }, title: { display: true, text: 'Unidades' } },
                x: { grid: { display: false }, title: { display: true, text: 'Número de Apuestas' } }
            }
        }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>
</body>
</html>
