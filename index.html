<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetAGS AI Pro - Ultra Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upscaler@1.0.0-beta.33/dist/browser/upscaler.min.js"></script>
    
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #238636; --text: #c9d1d9; --border: #30363d; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-width: 500px; width: 100%; text-align: center; }
        .status { font-size: 13px; margin: 15px 0; padding: 8px; border-radius: 6px; background: #21262d; border: 1px solid var(--border); }
        .preview-area { margin: 15px 0; border: 2px dashed var(--border); border-radius: 8px; min-height: 150px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { max-width: 100%; height: auto; display: block; }
        .btn { background: var(--accent); color: white; border: none; padding: 14px 20px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .info { font-size: 11px; color: #8b949e; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h3>AI Photo Sharpener Pro</h3>
    <div id="status" class="status">‚è≥ Cargando motor de IA...</div>
    
    <div class="preview-area" id="dropZone">
        <canvas id="mainCanvas"></canvas>
        <div id="placeholder">Sin imagen seleccionada</div>
    </div>

    <input type="file" id="upload" accept="image/*" style="display:none">
    <button class="btn" id="actionBtn" disabled onclick="document.getElementById('upload').click()">Seleccionar Foto</button>
    
    <div class="info">Optimizada para evitar errores de memoria en celulares.</div>
    <button id="dlBtn" class="btn" style="margin-top:10px; background:#30363d; display:none" onclick="download()">Descargar Resultado</button>
</div>

<script>
    let upscaler;
    const status = document.getElementById('status');
    const actionBtn = document.getElementById('actionBtn');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    // 1. Inicializar con limpieza de memoria
    async function init() {
        try {
            await tf.setBackend('webgl'); // Intenta GPU
            await tf.ready();
            upscaler = new Upscaler({
                model: { path: 'https://cdn.jsdelivr.net/npm/@upscalerjs/models@1.0.0-beta.4/models/esrgan-slim/2x/model.json', scale: 2 }
            });
            status.innerText = "‚úÖ Motor listo. Sube una foto.";
            actionBtn.disabled = false;
        } catch (e) {
            status.innerText = "‚ö†Ô∏è Modo compatibilidad activado.";
            await tf.setBackend('cpu');
            actionBtn.disabled = false;
        }
    }

    document.getElementById('upload').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async () => {
            // 2. AUTO-RESIZE: Si la imagen es gigante, la bajamos a un tama√±o seguro (m√°x 1200px)
            const MAX_SIZE = 1000; 
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            document.getElementById('placeholder').style.display = 'none';
            
            process(canvas);
        };
    };

    async function process(sourceCanvas) {
        actionBtn.disabled = true;
        status.innerText = "üß† Procesando p√≠xeles... (0%)";
        
        try {
            // 3. Gesti√≥n agresiva de tensores (limpieza de RAM)
            const result = await tf.tidy(() => {
                return upscaler.upscale(sourceCanvas, {
                    patchSize: 16, // Parches m√°s peque√±os = menos uso de RAM
                    padding: 2,
                    progress: (p) => { status.innerText = `üß† Procesando... ${Math.round(p * 100)}%`; }
                });
            });

            const enhancedImg = new Image();
            enhancedImg.src = await result;
            enhancedImg.onload = () => {
                canvas.width = enhancedImg.width;
                canvas.height = enhancedImg.height;
                ctx.drawImage(enhancedImg, 0, 0);
                status.innerText = "‚ú® ¬°Imagen mejorada con IA!";
                actionBtn.disabled = false;
                document.getElementById('dlBtn').style.display = 'block';
                
                // Limpiar tensores restantes
                tf.disposeVariables(); 
            };
        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå Error: La foto es muy pesada para este celular.";
            actionBtn.disabled = false;
        }
    }

    function download() {
        const link = document.createElement('a');
        link.download = 'BetAGS_AI_Enhanced.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }

    init();
</script>

</body>
</html>
