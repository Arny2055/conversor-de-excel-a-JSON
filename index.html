<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Analytics Pro - Betting Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e40af; --secondary: #0f172a; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: #1e293b; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        header { text-align: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .card h3 { margin: 0; font-size: 0.875rem; color: #64748b; text-transform: uppercase; }
        .card .value { font-size: 1.875rem; font-weight: 700; margin-top: 8px; }
        
        textarea { width: 100%; height: 120px; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 14px; margin-bottom: 15px; resize: none; }
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; height: 350px; }
        .interpretation { padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid #cbd5e1; background: white; }
        
        .kelly-box { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 20px; font-size: 13px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .win { color: var(--success); font-weight: bold; }
        .loss { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Poisson Analytics Pro</h1>
        <p>Herramienta Avanzada de Verificación de Estrategia</p>
    </header>

    <div class="card" style="margin-bottom: 30px;">
        <h3>Panel de Entrada de Datos</h3>
        <textarea id="csvData" placeholder="Pega aquí los datos de Excel (de Name hasta Overall ROI)..."></textarea>
        <button onclick="analyzeAll()">Ejecutar Análisis Profesional</button>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="grid">
            <div class="card"><h3>P-Value (Suerte)</h3><div id="v-pvalue" class="value">-</div></div>
            <div class="card"><h3>Yield Real</h3><div id="v-yield" class="value">-</div></div>
            <div class="card"><h3>Max Drawdown</h3><div id="v-dd" class="value" style="color:var(--danger)">-</div></div>
            <div class="card"><h3>Kelly Criterion (1u)</h3><div id="v-kelly" class="value" style="color:var(--primary)">-</div></div>
        </div>

        <div id="inter-text" class="interpretation"></div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="chart-box">
                <canvas id="mainChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="monteCarloChart"></canvas>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Desglose por Liga</h3>
            <table id="leagueTable">
                <thead>
                    <tr><th>Liga</th><th>Picks</th><th>Win %</th><th>Profit</th><th>Yield</th></tr>
                </thead>
                <tbody id="leagueBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let charts = {};

function analyzeAll() {
    const raw = document.getElementById('csvData').value.trim();
    if(!raw) return;

    const rows = raw.split('\n');
    let data = [];
    let leagues = {};

    rows.forEach(row => {
        const c = row.split('\t');
        const odd = parseFloat(c[2]);
        const result = c[36]?.trim().toLowerCase();
        const league = c[4]?.trim();

        if(!isNaN(odd) && (result === 'winning' || result === 'losing')) {
            const profit = result === 'winning' ? (odd - 1) : -1;
            const item = { odd, result, profit, league };
            data.push(item);

            if(!leagues[league]) leagues[league] = { n:0, w:0, p:0 };
            leagues[league].n++;
            if(result === 'winning') leagues[league].w++;
            leagues[league].p += profit;
        }
    });

    if(data.length === 0) return alert("Formato no válido");

    renderDashboard(data, leagues);
}

function renderDashboard(data, leagues) {
    document.getElementById('dashboard').style.display = 'block';

    // 1. Cálculos Base
    const n = data.length;
    const wins = data.filter(d => d.result === 'winning').length;
    const totalProfit = data.reduce((acc, d) => acc + d.profit, 0);
    const yieldPct = (totalProfit / n) * 100;
    const avgOdd = data.reduce((acc, d) => acc + d.odd, 0) / n;
    
    // 2. P-Value (Usando sum de probabilidades implícitas para mayor precisión)
    const expectedWins = data.reduce((acc, d) => acc + (1/d.odd), 0);
    const variance = data.reduce((acc, d) => acc + ((1/d.odd) * (1 - (1/d.odd))), 0);
    const zScore = (wins - expectedWins) / Math.sqrt(variance);
    const pValue = 1 - 0.5 * (1 + erf(zScore / Math.sqrt(2)));

    // 3. Max Drawdown
    let peak = 0, current = 0, mdd = 0;
    let history = [0];
    data.forEach(d => {
        current += d.profit;
        history.push(current);
        if(current > peak) peak = current;
        let dd = peak - current;
        if(dd > mdd) mdd = dd;
    });

    // 4. Kelly Criterion (Simplificado: Edge / (Odd - 1))
    const actualWinRate = wins / n;
    const edge = (actualWinRate * avgOdd) - 1;
    const kelly = edge > 0 ? (edge / (avgOdd - 1)) : 0;

    // Actualizar UI
    document.getElementById('v-pvalue').innerText = pValue.toFixed(4);
    document.getElementById('v-yield').innerText = yieldPct.toFixed(2) + '%';
    document.getElementById('v-dd').innerText = '-' + mdd.toFixed(2) + 'u';
    document.getElementById('v-kelly').innerText = (kelly * 100).toFixed(1) + '%';

    // Interpretación profesional
    const inter = document.getElementById('inter-text');
    let color = pValue < 0.01 ? "#166534" : (pValue < 0.05 ? "#1e40af" : "#991b1b");
    inter.style.borderColor = color;
    inter.innerHTML = `<strong>Análisis de Varianza:</strong> Con un P-Value de ${pValue.toFixed(4)}, la probabilidad de que este resultado sea azar es del ${(pValue*100).toFixed(2)}%. 
    ${pValue < 0.05 ? "Tu sistema muestra un Edge real." : "Cuidado: Los resultados no son estadísticamente significativos aún."} 
    <br><strong>Gestión de Banca:</strong> Se sugiere un stake del ${(kelly*100).toFixed(1)}% de tu banca actual para maximizar crecimiento según Kelly.`;

    // Gráficas
    updateCharts(history, n, actualWinRate);
    
    // Tabla de Ligas
    const lBody = document.getElementById('leagueBody');
    lBody.innerHTML = '';
    Object.keys(leagues).sort((a,b) => leagues[b].p - leagues[a].p).forEach(l => {
        const row = leagues[l];
        lBody.innerHTML += `<tr><td>${l}</td><td>${row.n}</td><td>${((row.w/row.n)*100).toFixed(1)}%</td>
        <td class="${row.p >= 0 ? 'win' : 'loss'}">${row.p.toFixed(2)}u</td><td>${((row.p/row.n)*100).toFixed(1)}%</td></tr>`;
    });
}

function updateCharts(history, n, winRate) {
    if(charts.main) charts.main.destroy();
    if(charts.monte) charts.monte.destroy();

    // Gráfico de Crecimiento
    charts.main = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
            labels: history.map((_, i) => i),
            datasets: [{ label: 'Profit Acumulado', data: history, borderColor: '#1e40af', tension: 0.2, fill: true, backgroundColor: 'rgba(30, 64, 175, 0.05)' }]
        },
        options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Curva de Beneficio Real' } } }
    });

    // Simulación Monte Carlo (Varianza proyectada)
    let sims = [];
    for(let i=0; i<5; i++) {
        let s = [0], cur = 0;
        for(let j=0; j<100; j++) {
            cur += Math.random() < winRate ? 1 : -1;
            s.push(cur);
        }
        sims.push(s);
    }

    charts.monte = new Chart(document.getElementById('monteCarloChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: 101}, (_, i) => i),
            datasets: sims.map((s, i) => ({
                label: `Sim ${i+1}`,
                data: s,
                borderColor: `rgba(100, 116, 139, 0.4)`,
                borderWidth: 1,
                pointRadius: 0
            }))
        },
        options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Simulación Monte Carlo (Próximos 100 picks)' } } }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>
</body>
</html>
