<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson Elite Analytics - BI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --cobalt: #1e3a8a; --emerald: #10b981; --rose: #ef4444; --amber: #f59e0b; --slate: #1e293b; --white: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0f172a; color: #f1f5f9; margin: 0; padding: 20px; }
        .wrapper { max-width: 1400px; margin: auto; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 20px; margin-bottom: 30px; }
        .main-input-area { background: #1e293b; padding: 25px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 30px; }
        textarea { width: 100%; height: 80px; background: #0f172a; border: 1px solid #475569; border-radius: 8px; color: #38bdf8; padding: 15px; font-family: 'Fira Code', monospace; font-size: 13px; }
        .btn-prime { background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; border: none; padding: 15px 40px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; font-size: 1.1rem; transition: 0.3s; }
        .btn-prime:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: #1e293b; padding: 20px; border-radius: 12px; border-top: 4px solid var(--cobalt); position: relative; overflow: hidden; }
        .kpi-card h4 { margin: 0; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card .val { font-size: 1.75rem; font-weight: 800; margin-top: 10px; display: block; }
        
        .visuals-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-container { background: #1e293b; padding: 20px; border-radius: 15px; height: 400px; border: 1px solid #334155; }
        
        .data-table-container { background: #1e293b; border-radius: 15px; overflow: hidden; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #334155; padding: 15px; font-size: 0.85rem; color: #cbd5e1; }
        td { padding: 12px 15px; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .bg-win { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .bg-loss { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="header-nav">
        <div>
            <h1 style="margin:0; color: #38bdf8;">Poisson Elite <span style="color:white">Analytics</span></h1>
            <small>Terminal de Inteligencia para Trading Deportivo</small>
        </div>
        <div id="status-clock">2026 Ready</div>
    </div>

    <div class="main-input-area">
        <textarea id="csvData" placeholder="Pega aquí los datos de Excel (todas las columnas)..."></textarea>
        <button class="btn-prime" onclick="initEliteAnalysis()">GENERAR INFORME DE INTELIGENCIA</button>
    </div>

    <div id="dashboard" style="display:none">
        <div class="kpi-grid">
            <div class="kpi-card" style="border-color: var(--emerald)"><h4>P-Value (Confianza)</h4><span id="k-p" class="val">0.00</span></div>
            <div class="kpi-card" style="border-color: #38bdf8"><h4>ROI / Yield</h4><span id="k-y" class="val">0%</span></div>
            <div class="kpi-card" style="border-color: var(--rose)"><h4>Max Drawdown</h4><span id="k-dd" class="val">0u</span></div>
            <div class="kpi-card" style="border-color: var(--amber)"><h4>Brier Score (Precisión)</h4><span id="k-brier" class="val">0.00</span></div>
            <div class="kpi-card"><h4>Edge vs Mercado</h4><span id="k-edge" class="val">0%</span></div>
        </div>

        <div class="visuals-grid">
            <div class="chart-container"><canvas id="equityChart"></canvas></div>
            <div class="chart-container"><canvas id="oddsDistribution"></canvas></div>
        </div>

        <div class="data-table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>EQUIPOS</th><th>LIGA</th><th>CUOTA</th><th>PREDICCIÓN</th><th>RESULTADO</th><th>PROFIT</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let charts = {};

function initEliteAnalysis() {
    const raw = document.getElementById('csvData').value.trim();
    if(!raw) return;

    const rows = raw.split('\n');
    let db = [];
    
    rows.forEach(r => {
        const c = r.split('\t');
        const odd = parseFloat(c[2]);
        const res = c[36]?.trim().toLowerCase();
        if(!isNaN(odd) && (res === 'winning' || res === 'losing')) {
            db.push({
                match: c[5], league: c[4], odd: odd,
                outcome: res, profit: res === 'winning' ? (odd - 1) : -1,
                probImplied: 1/odd,
                brier: res === 'winning' ? Math.pow(1 - (1/odd), 2) : Math.pow(0 - (1/odd), 2)
            });
        }
    });

    if(db.length === 0) return alert("Error: Formato de datos no reconocido.");
    renderElite(db);
}

function renderElite(db) {
    document.getElementById('dashboard').style.display = 'block';
    
    const n = db.length;
    const wins = db.filter(x => x.outcome === 'winning').length;
    const totalProfit = db.reduce((a, b) => a + b.profit, 0);
    const avgBrier = db.reduce((a, b) => a + b.brier, 0) / n;
    const sumProb = db.reduce((a, b) => a + b.probImplied, 0);
    
    // P-Value Avanzado
    const expectedWins = sumProb;
    const variance = db.reduce((a, b) => a + (b.probImplied * (1 - b.probImplied)), 0);
    const z = (wins - expectedWins) / Math.sqrt(variance);
    const pValue = 1 - (0.5 * (1 + erf(z / Math.sqrt(2))));

    // Equity & Drawdown
    let current = 0, peak = 0, mdd = 0, equity = [0];
    db.forEach(x => {
        current += x.profit;
        equity.push(current);
        if(current > peak) peak = current;
        if(peak - current > mdd) mdd = peak - current;
    });

    // Update UI
    document.getElementById('k-p').innerText = pValue.toFixed(4);
    document.getElementById('k-y').innerText = ((totalProfit/n)*100).toFixed(2) + '%';
    document.getElementById('k-dd').innerText = '-' + mdd.toFixed(2) + 'u';
    document.getElementById('k-brier').innerText = avgBrier.toFixed(3);
    document.getElementById('k-edge').innerText = (((wins/n) / (sumProb/n)) - 1).toFixed(2) + '%';

    updateVisuals(equity, db);
    
    // Table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = db.slice(-10).reverse().map(x => `
        <tr>
            <td>${x.match}</td><td>${x.league}</td><td>${x.odd.toFixed(2)}</td>
            <td>O2.5</td>
            <td><span class="badge ${x.outcome === 'winning' ? 'bg-win' : 'bg-loss'}">${x.outcome.toUpperCase()}</span></td>
            <td style="color:${x.profit > 0 ? '#10b981' : '#ef4444'}">${x.profit.toFixed(2)}u</td>
        </tr>
    `).join('');
}

function updateVisuals(equity, db) {
    if(charts.e) charts.e.destroy();
    if(charts.o) charts.o.destroy();

    const ctxE = document.getElementById('equityChart').getContext('2d');
    charts.e = new Chart(ctxE, {
        type: 'line',
        data: {
            labels: equity.map((_, i) => i),
            datasets: [{
                label: 'Crecimiento de Banca (Unidades)',
                data: equity,
                borderColor: '#38bdf8',
                borderWidth: 3,
                fill: true,
                backgroundColor: 'rgba(56, 189, 248, 0.1)',
                tension: 0.1,
                pointRadius: 0
            }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    // Distribución de Cuotas (Analiza dónde eres rentable)
    const ranges = ['1.0-1.5', '1.5-2.0', '2.0-2.5', '2.5+'];
    const distData = [0,0,0,0];
    db.forEach(x => {
        if(x.odd < 1.5) distData[0] += x.profit;
        else if(x.odd < 2.0) distData[1] += x.profit;
        else if(x.odd < 2.5) distData[2] += x.profit;
        else distData[3] += x.profit;
    });

    const ctxO = document.getElementById('oddsDistribution').getContext('2d');
    charts.o = new Chart(ctxO, {
        type: 'bar',
        data: {
            labels: ranges,
            datasets: [{
                label: 'Profit por Rango de Cuota',
                data: distData,
                backgroundColor: distData.map(v => v > 0 ? '#10b981' : '#ef4444')
            }]
        },
        options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Rentabilidad por Cuota', color: '#fff' } } }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>
</body>
</html>
