<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Poisson Analytics - Professional Filter Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --win: #10b981; --loss: #ef4444; --text: #f1f5f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        
        /* Header & Inputs */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .input-section { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        textarea { width: 100%; height: 60px; background: #0f172a; border: 1px solid #475569; border-radius: 6px; color: var(--accent); padding: 10px; font-family: monospace; }
        
        /* Filters Bar */
        .filters-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.75rem; color: #94a3b8; font-weight: bold; }
        select, input { background: #0f172a; border: 1px solid #475569; color: white; padding: 8px; border-radius: 4px; }

        /* KPIs */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--panel); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent); }
        .stat-card small { color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; }
        .stat-card div { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: var(--panel); padding: 15px; border-radius: 12px; height: 350px; }

        .btn { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { opacity: 0.8; }
        
        table { width: 100%; border-collapse: collapse; background: var(--panel); border-radius: 8px; overflow: hidden; font-size: 0.85rem; }
        th { background: #334155; padding: 12px; color: #cbd5e1; text-align: left; }
        td { padding: 10px 12px; border-bottom: 1px solid #334155; }
        .win-text { color: var(--win); }
        .loss-text { color: var(--loss); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Poisson <span style="color:var(--accent)">Intelligence</span></h1>
        <button class="btn" onclick="loadData()">Cargar Datos</button>
    </div>

    <div class="input-section">
        <textarea id="rawInput" placeholder="Pega aquí el contenido de tu Excel (incluyendo cabeceras)..."></textarea>
    </div>

    <div id="mainUI" style="display:none;">
        <div class="filters-bar">
            <div class="filter-group">
                <label>Liga</label>
                <select id="f-league" onchange="applyFilters()"><option value="all">Todas las Ligas</option></select>
            </div>
            <div class="filter-group">
                <label>Cuota Mín</label>
                <input type="number" id="f-odd-min" step="0.1" value="1.0" oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Cuota Máx</label>
                <input type="number" id="f-odd-max" step="0.1" value="20.0" oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>Resultado</label>
                <select id="f-res" onchange="applyFilters()">
                    <option value="all">Todos</option>
                    <option value="winning">Winning</option>
                    <option value="losing">Losing</option>
                </select>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><small>Picks Filtrados</small><div id="s-total">0</div></div>
            <div class="stat-card"><small>Yield / ROI</small><div id="s-yield">0%</div></div>
            <div class="stat-card"><small>P-Value (Suerte)</small><div id="s-p">0.00</div></div>
            <div class="stat-card"><small>Profit Total</small><div id="s-profit">0u</div></div>
        </div>

        <div class="charts-row">
            <div class="chart-box"><canvas id="chartEquity"></canvas></div>
            <div class="chart-box"><canvas id="chartLigas"></canvas></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Fecha</th><th>Partido</th><th>Liga</th><th>Cuota</th><th>Resultado</th><th>Profit</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
let globalData = [];
let charts = {};

function loadData() {
    const raw = document.getElementById('rawInput').value.trim();
    if(!raw) return;

    const rows = raw.split('\n');
    globalData = [];
    const leagueSet = new Set();

    rows.forEach(r => {
        const c = r.split('\t');
        const odd = parseFloat(c[2]);
        const res = c[36]?.trim().toLowerCase();
        if(!isNaN(odd) && (res === 'winning' || res === 'losing')) {
            globalData.push({
                date: c[3],
                match: c[5],
                league: c[4]?.trim(),
                odd: odd,
                res: res,
                profit: res === 'winning' ? (odd - 1) : -1,
                implied: 1/odd
            });
            leagueSet.add(c[4]?.trim());
        }
    });

    // Poblar Selector de Ligas
    const sel = document.getElementById('f-league');
    sel.innerHTML = '<option value="all">Todas las Ligas</option>';
    Array.from(leagueSet).sort().forEach(l => {
        sel.innerHTML += `<option value="${l}">${l}</option>`;
    });

    document.getElementById('mainUI').style.display = 'block';
    applyFilters();
}

function applyFilters() {
    const league = document.getElementById('f-league').value;
    const minOdd = parseFloat(document.getElementById('f-odd-min').value);
    const maxOdd = parseFloat(document.getElementById('f-odd-max').value);
    const resFilter = document.getElementById('f-res').value;

    const filtered = globalData.filter(d => {
        return (league === 'all' || d.league === league) &&
               (d.odd >= minOdd && d.odd <= maxOdd) &&
               (resFilter === 'all' || d.res === resFilter);
    });

    updateDashboard(filtered);
}

function updateDashboard(data) {
    const n = data.length;
    if(n === 0) return;

    const wins = data.filter(x => x.res === 'winning').length;
    const totalProfit = data.reduce((a, b) => a + b.profit, 0);
    const yieldPct = (totalProfit / n) * 100;
    
    // P-Value
    const expectedWins = data.reduce((a, b) => a + b.implied, 0);
    const variance = data.reduce((a, b) => a + (b.implied * (1 - b.implied)), 0);
    const z = (wins - expectedWins) / Math.sqrt(variance);
    const pValue = 1 - (0.5 * (1 + erf(z / Math.sqrt(2))));

    // UI Stats
    document.getElementById('s-total').innerText = n;
    document.getElementById('s-yield').innerText = yieldPct.toFixed(2) + '%';
    document.getElementById('s-p').innerText = pValue.toFixed(4);
    document.getElementById('s-profit').innerText = totalProfit.toFixed(2) + 'u';

    // Tabla
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = data.slice(-15).reverse().map(x => `
        <tr>
            <td>${x.date}</td><td>${x.match}</td><td>${x.league}</td>
            <td>${x.odd.toFixed(2)}</td>
            <td class="${x.res === 'winning' ? 'win-text' : 'loss-text'}">${x.res.toUpperCase()}</td>
            <td class="${x.profit > 0 ? 'win-text' : 'loss-text'}">${x.profit.toFixed(2)}u</td>
        </tr>
    `).join('');

    renderCharts(data);
}

function renderCharts(data) {
    if(charts.e) charts.e.destroy();
    if(charts.l) charts.l.destroy();

    // Equity Chart
    let cur = 0;
    const equityData = data.map(x => cur += x.profit);
    
    charts.e = new Chart(document.getElementById('chartEquity'), {
        type: 'line',
        data: {
            labels: data.map((_, i) => i + 1),
            datasets: [{
                label: 'Beneficio Acumulado',
                data: equityData,
                borderColor: '#38bdf8',
                backgroundColor: 'rgba(56, 189, 248, 0.1)',
                fill: true, tension: 0.1, pointRadius: 2
            }]
        },
        options: { maintainAspectRatio: false }
    });

    // Ligas Chart (Top 5 Profit)
    const lMap = {};
    data.forEach(x => {
        lMap[x.league] = (lMap[x.league] || 0) + x.profit;
    });
    const topLigas = Object.entries(lMap).sort((a,b) => b[1] - a[1]).slice(0, 5);

    charts.l = new Chart(document.getElementById('chartLigas'), {
        type: 'bar',
        data: {
            labels: topLigas.map(x => x[0]),
            datasets: [{
                label: 'Profit por Liga',
                data: topLigas.map(x => x[1]),
                backgroundColor: '#10b981'
            }]
        },
        options: { maintainAspectRatio: false }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>
</body>
</html>
