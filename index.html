<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookie Slayer v3.0 - Poisson Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0f1e; --card: #161c2d; --accent: #00f2ff; --win: #00ff88; --loss: #ff0055; --text: #e2e8f0; --gold: #ffd700; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; font-size: 14px; }
        
        /* Layout */
        .grid-main { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 1200px; margin: auto; }
        @media (min-width: 1024px) { .grid-main { grid-template-columns: 350px 1fr; } }

        /* Componentes */
        .glass-card { background: var(--card); border: 1px solid #2d3748; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .input-area { width: 100%; height: 120px; background: #050811; border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); padding: 12px; font-family: 'Fira Code', monospace; font-size: 11px; margin-bottom: 10px; }
        
        .btn-action { background: linear-gradient(90deg, #00c6ff, #0072ff); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: 800; width: 100%; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-action:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--accent); }

        /* Stats & Badges */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-item { background: #1c2539; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 3px solid #334155; }
        .stat-item.gold { border-color: var(--gold); }
        .stat-val { font-size: 1.4rem; font-weight: 900; display: block; color: var(--accent); }
        
        /* Insights Box */
        .insight-box { background: rgba(0, 242, 255, 0.05); border-left: 4px solid var(--accent); padding: 15px; margin-top: 20px; }
        .insight-msg { margin-bottom: 10px; font-style: italic; color: #cbd5e1; }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        th { background: #1c2539; padding: 12px; text-align: left; color: var(--accent); font-size: 11px; }
        td { padding: 12px; border-bottom: 1px solid #2d3748; font-size: 12px; }
        
        .winning { color: var(--win); font-weight: bold; }
        .losing { color: var(--loss); font-weight: bold; }
        
        /* Animación de carga */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .loading { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>

<div class="grid-main">
    <aside class="glass-card">
        <h2 style="color: var(--accent); margin-top: 0;">TERMINAL V3.0</h2>
        <p style="font-size: 11px; color: #94a3b8;">SISTEMA DE ANÁLISIS DE VARIANZA CRÍTICA</p>
        
        <textarea id="dataInput" class="input-area" placeholder="Pega el historial completo..."></textarea>
        <button class="btn-action" onclick="analyzeHistory()">Inyectar Datos</button>

        <div id="quickStats" style="display:none;">
            <div class="stat-grid">
                <div class="stat-item">
                    <small>EV TOTAL</small>
                    <span id="ev-val" class="stat-val">0%</span>
                </div>
                <div class="stat-item gold">
                    <small>P-VALUE</small>
                    <span id="p-val" class="stat-val">1.0</span>
                </div>
            </div>
            <div class="insight-box" id="insight-container">
                <div id="verdict" style="font-weight: bold; color: var(--gold); margin-bottom: 5px;"></div>
                <div id="advice" class="insight-msg">Esperando datos...</div>
            </div>
        </div>
    </aside>

    <main class="glass-card" id="mainDashboard" style="display:none;">
        <div style="height: 300px; margin-bottom: 30px;">
            <canvas id="equityChart"></canvas>
        </div>

        <div class="stat-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <div class="stat-item"><small>MAX DRAWDOWN</small><span id="dd-val" style="color:var(--loss)">-0u</span></div>
            <div class="stat-item"><small>EXPECTED WINRATE</small><span id="ewr-val">0%</span></div>
            <div class="stat-item"><small>Z-SCORE</small><span id="z-val">0.0</span></div>
            <div class="stat-item"><small>YIELD</small><span id="yield-val">0%</span></div>
        </div>

        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>FECHA</th><th>PARTIDO</th><th>LIGA</th><th>CUOTA</th><th>RES</th><th>PROFIT</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
let chartInstance = null;

function analyzeHistory() {
    const raw = document.getElementById('dataInput').value.trim();
    if(!raw) return;

    const rows = raw.split('\n');
    let picks = [];
    
    rows.forEach(row => {
        const c = row.split('\t');
        const odd = parseFloat(c[2]);
        const result = c[36]?.trim().toLowerCase();
        if(!isNaN(odd) && (result === 'winning' || result === 'losing')) {
            picks.push({
                date: c[3], match: c[5], league: c[4],
                odd: odd, res: result,
                profit: result === 'winning' ? (odd - 1) : -1,
                probImplied: 1/odd
            });
        }
    });

    if(picks.length === 0) { alert("Formato inválido. Asegúrate de copiar desde la columna 'Name' hasta 'Overall ROI'."); return; }
    
    processEliteStats(picks);
}

function processEliteStats(picks) {
    document.getElementById('quickStats').style.display = 'block';
    document.getElementById('mainDashboard').style.display = 'block';

    const n = picks.length;
    const wins = picks.filter(p => p.res === 'winning').length;
    const netProfit = picks.reduce((a, b) => a + b.profit, 0);
    const yieldPct = (netProfit / n) * 100;
    
    // Cálculo de Esperanza Matemática vs Realidad
    const expectedWins = picks.reduce((a, b) => a + b.probImplied, 0);
    const variance = picks.reduce((a, b) => a + (b.probImplied * (1 - b.probImplied)), 0);
    const zScore = (wins - expectedWins) / Math.sqrt(variance);
    const pValue = 1 - 0.5 * (1 + erf(zScore / Math.sqrt(2)));

    // Max Drawdown & Equity
    let cur = 0, peak = 0, mdd = 0, equity = [0];
    picks.forEach(p => {
        cur += p.profit;
        equity.push(cur);
        if(cur > peak) peak = cur;
        if(peak - cur > mdd) mdd = peak - cur;
    });

    // Actualizar UI
    document.getElementById('ev-val').innerText = ((wins/n)*100).toFixed(1) + "%";
    document.getElementById('p-val').innerText = pValue.toFixed(4);
    document.getElementById('yield-val').innerText = yieldPct.toFixed(2) + "%";
    document.getElementById('z-val').innerText = zScore.toFixed(2);
    document.getElementById('dd-val').innerText = "-" + mdd.toFixed(2) + "u";
    document.getElementById('ewr-val').innerText = ((expectedWins/n)*100).toFixed(1) + "%";

    // Veredicto del Sistema
    const verdict = document.getElementById('verdict');
    const advice = document.getElementById('advice');
    
    if(pValue < 0.01) {
        verdict.innerText = "SISTEMA ELITE";
        advice.innerText = "La probabilidad de que esto sea suerte es menor al 1%. Tienes una ventaja matemática real sobre la casa.";
    } else if(pValue < 0.05) {
        verdict.innerText = "VENTAJA CONFIRMADA";
        advice.innerText = "Resultados sólidos. El modelo de Poisson está capturando ineficiencias en el mercado.";
    } else {
        verdict.innerText = "VARIANZA ALTA";
        advice.innerText = "Cuidado: Tu éxito podría ser suerte estadística. Necesitas al menos 100 picks más para confirmar el Edge.";
    }

    renderChart(equity);
    
    // Tabla
    document.getElementById('tableBody').innerHTML = picks.slice(-10).reverse().map(p => `
        <tr>
            <td>${p.date}</td><td>${p.match}</td><td>${p.league}</td>
            <td>@${p.odd.toFixed(2)}</td>
            <td class="${p.res}">${p.res.toUpperCase()}</td>
            <td class="${p.profit > 0 ? 'winning' : 'losing'}">${p.profit.toFixed(2)}u</td>
        </tr>
    `).join('');
}

function renderChart(data) {
    const ctx = document.getElementById('equityChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map((_, i) => i),
            datasets: [{
                label: 'Profit Acumulado',
                data: data,
                borderColor: '#00f2ff',
                backgroundColor: 'rgba(0, 242, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { grid: { color: '#2d3748' }, ticks: { color: '#94a3b8' } },
                x: { display: false }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function erf(x) {
    const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
    const p = 0.3275911;
    const sign = (x < 0) ? -1 : 1;
    x = Math.abs(x);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a[4] * t + a[3]) * t) + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x);
    return sign * y;
}
</script>

</body>
</html>
